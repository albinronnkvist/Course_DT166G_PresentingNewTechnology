using System.Collections.ObjectModel;
using System.Text.Json;
using AlbinRonnkvist.HybridSearch.Core.Constants;
using AlbinRonnkvist.HybridSearch.Core.Helpers;
using AlbinRonnkvist.HybridSearch.Core.Models;
using AlbinRonnkvist.HybridSearch.Embedding.Services;
using AlbinRonnkvist.HybridSearch.Job.Initializer.Options;
using AlbinRonnkvist.HybridSearch.Job.Initializer.Services;
using CSharpFunctionalExtensions;
using Microsoft.Extensions.Options;

namespace AlbinRonnkvist.HybridSearch.Job.Initializer.Indices.ProductIndex;

public class ProductIndexDocumentManager(IDocumentManager<Product> documentManager,
    IEmbeddingGenerator embeddingGenerator,
    IOptions<ProductIndexOptions> options) : IProductIndexDocumentManager
{
    private readonly IDocumentManager<Product> _documentManager = documentManager;
    private readonly IEmbeddingGenerator _embeddingGenerator = embeddingGenerator;
    private readonly ProductIndexOptions _options = options.Value;

    public async Task<UnitResult<string>> CreateDocuments(int newVersion, CancellationToken ct)
    {
        var newVersionedIndexName = IndexNamingConvention.GetVersionedIndexName(ProductIndexConstants.IndexName, newVersion);

        var extractDataResult = await ExtractData();
        if (extractDataResult.IsFailure)
        {
            return UnitResult.Failure(extractDataResult.Error);
        }

        var transformDataResult = await TransformData(extractDataResult.Value);
        if (transformDataResult.IsFailure)
        {
            return UnitResult.Failure(transformDataResult.Error);
        }

        var result = await _documentManager.CreateDocuments(newVersionedIndexName, transformDataResult.Value, ct);
        if (result.IsFailure)
        {
            return UnitResult.Failure(result.Error);
        }

        return UnitResult.Success<string>();
    }

    // Temp solution
    private static async Task<Result<string, string>> ExtractData()
    {
        var baseDirectory = AppContext.BaseDirectory;
        var filePath = Path.Combine(baseDirectory, "Indices", "ProductIndex", "products-example.json");        
        if (!File.Exists(filePath))
        {
            return Result.Failure<string, string>("File not found: " + filePath);
        }

        var jsonData = await File.ReadAllTextAsync(filePath);

        return Result.Success<string, string>(jsonData);
    }

    private async Task<Result<ReadOnlyCollection<Product>, string>> TransformData(string extractedData)
    {
        if(string.IsNullOrWhiteSpace(extractedData))
        {
            return Result.Failure<ReadOnlyCollection<Product>, string>("No data provided");
        }

        var productDtos = JsonSerializer.Deserialize<List<ProductDto>>(extractedData);
        if (productDtos is null || productDtos.Count is 0) 
        {
            return Result.Failure<ReadOnlyCollection<Product>, string>("Failed to deserialize products");
        }

        var products = new List<Product>();
        foreach (var product in productDtos)
        {
            if(_options.GenerateEmbeddings)
            {
                var embedding = await _embeddingGenerator.GenerateEmbedding(product.Title, ProductIndexConstants.EmbeddingDimensions);
                if (embedding.IsFailure)
                {
                    return Result.Failure<ReadOnlyCollection<Product>, string>("Failed to generate embedding for product: " + product.Title);
                }

                products.Add(new Product
                {
                    Id = product.Id,
                    Title = product.Title,
                    TitleEmbedding = embedding.Value
                });
            }
            else
            {
                products.Add(new Product
                {
                    Id = product.Id,
                    Title = product.Title,
                    TitleEmbedding = DefaultEmbedding
                });
            }
        }

        return Result.Success<ReadOnlyCollection<Product>, string>(products.AsReadOnly());
    }

    private readonly decimal[] DefaultEmbedding = [
            0.0059575066m,
            0.0037016033m,
            -0.012421664m,
            -0.02316614m,
            0.028407348m,
            -0.08875112m,
            -0.033281673m,
            0.043991208m,
            0.017042661m,
            0.022327546m,
            0.030014653m,
            0.046926282m,
            -0.055277277m,
            0.020405771m,
            0.011251127m,
            -0.034417268m,
            -0.052761495m,
            -0.030311653m,
            -0.027219342m,
            -0.0071498817m,
            0.052831378m,
            0.047694996m,
            0.0080321515m,
            -0.06848512m,
            -0.010499887m,
            0.019934062m,
            0.027236812m,
            -0.022327546m,
            0.012596371m,
            -0.0017612643m,
            0.035343215m,
            -0.027568756m,
            0.017977344m,
            -0.059225652m,
            -0.032355726m,
            -0.050420422m,
            -0.017112544m,
            -0.049966186m,
            0.016247746m,
            0.046996165m,
            -0.007861813m,
            -0.0005104718m,
            -0.027778404m,
            0.009110967m,
            0.02996224m,
            0.025909038m,
            -0.07575293m,
            -0.031884015m,
            -0.0024240587m,
            0.040182594m,
            -0.023113728m,
            0.0035268962m,
            0.012482811m,
            0.07729035m,
            0.0054028123m,
            -0.025489742m,
            -0.021803426m,
            -0.025978921m,
            0.0775m,
            -0.02568192m,
            -0.02592651m,
            0.022676961m,
            0.042244136m,
            0.00015109421m,
            -0.020947361m,
            -0.028162759m,
            -0.025384918m,
            0.004708352m,
            -0.05111925m,
            -0.02388244m,
            -0.0553821m,
            -0.065375336m,
            -0.0128234895m,
            -0.0025223314m,
            0.0054508564m,
            -0.022554666m,
            -0.01991659m,
            -0.025734331m,
            0.019444883m,
            -0.030608656m,
            -0.03724752m,
            0.023725202m,
            -0.0146055m,
            0.004361122m,
            -0.004391696m,
            -0.0533555m,
            -0.035814922m,
            0.024755973m,
            -0.092035614m,
            -0.00655151m,
            0.026013862m,
            -0.046751577m,
            0.048987824m,
            0.020335888m,
            0.00054650515m,
            0.041405544m,
            0.006433583m,
            -0.03426003m,
            0.03780658m,
            0.039169297m,
            0.026800044m,
            -0.019427411m,
            -0.030259242m,
            0.0035531025m,
            0.022956492m,
            -0.012570164m,
            -0.051014427m,
            -0.021768484m,
            -0.005686711m,
            -0.012098456m,
            -0.078897655m,
            0.041195896m,
            -0.031569544m,
            -0.009477852m,
            -0.0346968m,
            -0.003867575m,
            0.060832955m,
            -0.076102346m,
            -0.012456605m,
            -0.063104145m,
            -0.029909829m,
            0.12557934m,
            0.02388244m,
            -0.09448151m,
            0.029892357m,
            0.024581267m,
            -0.018012285m,
            -0.07945672m,
            -0.005284885m,
            -0.055242334m,
            0.004284688m,
            -0.03520345m,
            0.054648332m,
            -0.062020965m,
            -0.028319994m,
            0.044724975m,
            0.0006300369m,
            -0.04503945m,
            -0.025297565m,
            -0.019881649m,
            -0.030748421m,
            0.05660505m,
            0.0061889933m,
            0.004961677m,
            -0.026293395m,
            0.007276544m,
            0.018082168m,
            0.0026118688m,
            -0.015278121m,
            0.05108431m,
            0.0109191835m,
            -0.014325969m,
            -0.032338254m,
            -0.004339284m,
            0.034347385m,
            -0.07833859m,
            0.014762736m,
            0.039938007m,
            -0.05667493m,
            -0.057862937m,
            -0.00072012015m,
            -0.026607867m,
            0.036373984m,
            0.016492335m,
            0.01813458m,
            -0.024389088m,
            -0.017697813m,
            0.079177186m,
            -0.08840171m,
            0.052936204m,
            0.0004924552m,
            0.021436542m,
            -0.023602907m,
            0.020964833m,
            0.039448828m,
            0.0017481613m,
            0.030783363m,
            0.045144275m,
            -0.050175834m,
            -0.05870153m,
            -0.046437103m,
            -0.029228471m,
            -0.05670987m,
            -0.020737713m,
            0.0019152248m,
            0.0066956435m,
            0.012098456m,
            -0.03453956m,
            -0.05387962m,
            -0.0043283645m,
            0.01834423m,
            -0.0018704562m,
            0.021244364m,
            0.09280433m,
            0.00090137863m,
            -0.054788098m,
            0.019340059m,
            -0.030696008m,
            -0.0031752987m,
            -0.029001351m,
            0.03675834m,
            0.029560413m,
            -0.0022286053m,
            -0.068170644m,
            -0.027097046m,
            -0.018082168m,
            -0.065375336m,
            0.022100428m,
            0.061357077m,
            0.04863841m,
            0.045214158m,
            -0.045388862m,
            -0.02797058m,
            -0.04427074m,
            -0.0061060074m,
            -0.0037409123m,
            0.007494928m,
            0.016701983m,
            0.08295085m,
            0.0021478035m,
            -0.041720018m,
            0.030573715m,
            -0.02797058m,
            0.020580478m,
            0.012832224m,
            0.0060666986m,
            0.01158307m,
            -0.0061671548m,
            0.007975372m,
            -0.045179214m,
            -0.052167494m,
            -0.009984502m,
            -0.057059288m,
            -0.014282293m,
            0.07400586m,
            0.06495604m,
            -0.025629507m,
            0.012543959m,
            -0.0139678195m,
            -0.03927412m,
            -0.014588029m,
            -0.0044856006m,
            0.005765329m,
            -0.06925383m,
            0.025087917m,
            -0.0640825m,
            -0.0020003945m,
            -0.006472892m,
            -0.036059514m,
            0.030416477m,
            -0.036548693m,
            0.036618575m,
            -0.039344m,
            -0.0417899m,
            0.0013113939m,
            -0.008268006m,
            -0.08728359m,
            -0.0035487348m,
            -0.0072547058m,
            -0.060832955m,
            -0.028774234m,
            0.01498112m,
            -0.064816274m,
            -0.028459761m,
            0.024790915m,
            0.041440487m,
            -0.04891794m,
            -0.015784772m,
            0.012360516m,
            -0.023201082m,
            0.0028411716m,
            0.034871504m,
            0.010735742m,
            -0.009696235m,
            0.007010116m,
            -0.023375789m,
            0.0041711284m,
            -0.023585437m,
            -0.03927412m,
            -0.0017841946m,
            -0.04783476m,
            -0.018274346m,
            0.025227683m,
            0.049896304m,
            -0.02138413m,
            -0.0013583464m,
            0.04427074m,
            -0.04206943m,
            -0.027411519m,
            -0.012954519m,
            0.011932484m,
            0.016230274m,
            -0.043641794m,
            -0.013504846m,
            0.033299144m,
            0.013810583m,
            -0.08546664m,
            0.077639766m,
            -0.008761553m,
            -0.004939839m,
            0.017505635m,
            -0.02943812m,
            -0.028407348m,
            0.036828224m,
            -0.0815532m,
            0.035151035m,
            -0.04151037m,
            0.01939247m,
            -0.050490305m,
            0.023393258m,
            0.014640441m,
            0.017610459m,
            0.03024177m,
            0.040951308m,
            -0.045249097m,
            -0.06009919m,
            -0.037701756m,
            -0.025105387m,
            0.04409603m,
            -0.06886948m,
            0.081692964m,
            0.029752592m,
            -0.016273951m,
            0.0056648725m,
            0.00503156m,
            0.021226892m,
            0.049686655m,
            -0.025297565m,
            -0.030346595m,
            -0.03321179m,
            0.045388862m,
            0.05108431m,
            -0.03602457m,
            -0.040811542m,
            0.02293902m,
            -0.07176961m,
            -0.043956265m,
            0.02872182m,
            -0.042593554m,
            -0.059365418m,
            -0.05744364m,
            -0.005979345m,
            -0.05545198m,
            -0.0030595553m,
            0.018064698m,
            -0.007464354m,
            0.0523422m,
            0.06397768m,
            0.028547114m,
            0.0076041194m,
            -0.021069657m,
            0.013845525m,
            0.032914788m,
            0.046506986m,
            -0.051922902m,
            -0.057827998m,
            0.012107191m,
            0.0036491912m,
            -0.028616996m,
            0.050245717m,
            -0.013976555m,
            -0.01030771m,
            -0.021122068m,
            0.00061747985m,
            -0.0069314977m,
            0.05933048m,
            -0.04049707m,
            0.104754284m,
            0.026957281m,
            0.03619928m,
            0.020790126m,
            0.053006086m,
            -0.019811766m,
            -0.016675778m,
            -0.048393823m,
            -0.070371956m,
            0.010665859m,
            0.0352908m,
            -0.014806413m,
            -0.01599442m,
            -0.006700011m,
            0.004134003m,
            0.0060404926m,
            -0.011810189m,
            0.023375789m,
            0.025856627m,
            -0.032617785m,
            0.027236812m,
            -0.06254508m,
            -0.056360457m,
            0.00497478m,
            -0.027760932m,
            -0.03598963m,
            0.030381536m,
            0.01574983m,
            -0.020807596m,
            0.07812894m,
            -0.027533814m,
            0.020790126m,
            0.020056356m,
            -0.013251522m,
            0.021751015m,
            -0.011504452m,
            -0.051538546m,
            0.057268936m,
            -0.044655092m,
            0.06411745m,
            -0.0039025163m,
            0.012238221m,
            0.015120885m,
            0.04804441m,
            -0.0815532m,
            0.008167549m,
            0.010237827m,
            -0.009530264m,
            -0.07533363m,
            -0.015802242m,
            -0.023707733m,
            0.00993209m,
            0.018973174m,
            -0.017095074m,
            0.0423839m,
            -0.03401544m,
            0.049896304m,
            -0.0074294126m,
            0.019776825m,
            -0.021349188m,
            -0.06324391m,
            -0.012063514m,
            -0.025122859m,
            -0.05489292m,
            0.0071149403m,
            0.039623532m,
            0.023672791m,
            0.0051931636m,
            0.0044244532m,
            -0.068555005m,
            -0.037142694m,
            -0.022275135m,
            0.026869927m,
            0.059994362m,
            0.0022690063m,
            0.014159997m,
            0.049477004m,
            -0.018483995m,
            0.03024177m,
            -0.04500451m,
            0.033369027m,
            -0.026834985m,
            -0.054962803m,
            -0.035185978m,
            0.02213537m,
            0.018973174m,
            0.023847498m,
            -0.0031600117m,
            0.01132101m,
            0.018274346m,
            -0.02970018m,
            -0.02541986m,
            0.055102568m,
            0.038365643m,
            0.039448828m,
            -0.033840735m,
            -0.09315374m,
            0.007342059m,
            -0.018291816m,
            0.051713254m,
            0.053285617m,
            -0.03352626m,
            0.0027188768m,
            -0.043187555m,
            -0.006285082m,
            0.057583407m,
            0.027813345m,
            0.02543733m,
            0.022694431m,
            0.0062151994m,
            0.0014227696m,
            -0.0072721764m,
            -0.0071411463m,
            -0.06579463m,
            -0.010281503m,
            -0.08483769m,
            0.034819093m,
            -0.035884805m,
            0.06425721m,
            -0.028459761m,
            0.010796889m,
            -0.0932935m,
            0.015085944m,
            -0.054438684m,
            -0.016920367m,
            0.061951082m,
            -0.020318417m,
            0.018221933m,
            -0.0014926525m,
            -0.060832955m,
            -0.04360685m,
            0.049756538m,
            0.0122818975m,
            -0.034609444m,
            0.0072284997m,
            -0.027795874m,
            0.017828843m,
            0.0316569m,
            -0.021052185m,
            0.043117672m,
            -0.0067960997m,
            -0.030626126m,
            -0.004101245m,
            0.07938683m,
            -0.018309288m,
            -0.011041478m,
            -0.0048350147m,
            -0.0040182597m,
            -0.044655092m,
            -0.04255861m,
            0.021087127m,
            -0.024493912m,
            -0.059260596m,
            -0.0049267355m,
            -0.008067093m,
            -0.022764314m,
            -0.05108431m,
            0.029350765m,
            -0.04332732m,
            0.023323376m,
            -0.067017585m,
            -0.02896641m,
            -0.0051058102m,
            -0.01297199m,
            -0.014378381m,
            -0.04427074m,
            -0.035273332m,
            -0.045144275m,
            -0.0067742616m,
            0.04430568m,
            -0.019532235m,
            -0.01535674m,
            0.0011017456m,
            0.018711112m,
            0.024371618m,
            0.0251578m,
            -0.011984896m,
            -0.0156013295m,
            -0.031150248m,
            0.05307597m,
            -0.022816727m,
            0.025874097m,
            -0.022082957m,
            -0.0084121395m,
            -0.015182033m,
            0.017252311m,
            0.024546325m,
            -0.0018235036m,
            -0.034836564m,
            0.020196123m,
            0.00055032683m,
            -0.024214381m,
            -0.004734558m,
            0.023795085m,
            0.021925721m,
            -0.020545537m,
            -0.030591184m,
            0.019497294m,
            0.021104598m,
            0.029018823m,
            0.0061409487m,
            -0.012447869m,
            -0.03979824m,
            -0.019409942m,
            -0.0041383705m,
            0.02645063m,
            0.020964833m,
            0.07659152m,
            0.0109191835m,
            -0.016186599m,
            0.008661097m,
            0.029036293m,
            0.015802242m,
            -0.009041084m,
            -0.016204068m,
            -0.0012022022m,
            -0.004107797m,
            -0.046122633m,
            -0.0014173101m,
            -0.016020626m,
            0.031290013m,
            0.02265949m,
            -0.009207056m,
            0.028564585m,
            -0.015138356m,
            -0.057862937m,
            -0.0309406m,
            0.006848512m,
            -0.01834423m,
            -0.019375m,
            0.029997181m,
            -0.01582845m,
            -0.03370097m,
            0.019811766m,
            -0.027062105m,
            -0.03473174m,
            0.008486389m,
            -0.06586452m,
            -0.026013862m,
            0.022240194m,
            0.026310865m,
            0.05108431m,
            0.005494533m,
            -0.010089326m,
            0.010036914m,
            -0.0076084873m,
            0.0057478584m,
            -0.03801623m,
            -0.006407377m,
            0.0058483146m,
            -0.016728189m,
            0.0025463537m,
            -0.030591184m,
            -0.027411519m,
            -0.026520513m,
            0.034417268m,
            0.024633678m,
            0.052516907m,
            -0.015295592m,
            -0.013775642m,
            0.005101443m,
            -0.04891794m,
            -0.025769273m,
            0.046506986m,
            0.028075404m,
            0.029560413m,
            0.025577096m,
            -0.029228471m,
            0.027708521m,
            -0.016675778m,
            -0.011137567m,
            0.00393309m,
            -0.023760144m,
            -0.023480613m,
            -0.036863163m,
            0.051224075m,
            -0.015706154m,
            0.021873308m,
            0.03480162m,
            0.012325575m,
            -0.01837917m,
            -0.017750226m,
            -0.018955704m,
            0.012771077m,
            -0.011521922m,
            0.018082168m,
            -0.009731176m,
            0.01961959m,
            0.018833408m,
            -0.018431582m,
            -0.08875112m,
            0.02141907m,
            0.029647768m,
            -0.028267583m,
            -0.059050944m,
            -0.06418733m,
            0.0067480556m,
            -0.04301285m,
            0.043851443m,
            -0.015645007m,
            0.05063007m,
            -0.00015737273m,
            -0.0118451305m,
            0.021820897m,
            0.014518146m,
            -0.016623365m,
            0.007333324m,
            -0.026852457m,
            0.028127817m,
            -0.01447447m,
            -0.040392246m,
            0.026747633m,
            0.029403178m,
            0.008289845m,
            0.014413322m,
            -0.05087466m,
            0.007896754m,
            0.027865756m,
            -0.006529672m,
            0.011163773m,
            0.016160391m,
            0.045843102m,
            -0.04832394m,
            -0.014002761m,
            0.0034155208m,
            -0.01409885m,
            -0.018291816m,
            -0.027131988m,
            -0.008665464m,
            0.012954519m,
            0.038225878m,
            -0.019357529m,
            -0.15905319m,
            -0.03983318m,
            0.09518034m,
            -0.0031381734m,
            -0.07197926m,
            -0.019340059m,
            -0.060588367m,
            -0.027778404m,
            -0.014806413m,
            -0.004966045m,
            0.007984107m,
            0.00023053127m,
            -0.016160391m,
            -0.028057935m,
            -0.021943191m,
            0.0153305335m,
            -0.034312442m,
            -0.032373197m,
            -0.016833013m,
            0.063104145m,
            -0.048778176m,
            -0.0068048355m,
            0.0008347716m,
            -0.0036011469m,
            -0.04378156m,
            0.0051145456m,
            -0.056011043m,
            -0.042418845m,
            0.005175693m,
            -0.037177637m,
            0.057513524m,
            0.06334873m,
            0.033369027m,
            0.0024044043m,
            -0.0020309682m,
            -0.006970807m,
            -0.016291423m,
            -0.048393823m,
            -0.07414562m,
            0.032565374m,
            -0.034312442m,
            -0.053704914m,
            -0.0123343095m,
            -0.046891343m,
            -0.03647881m,
            0.04881312m,
            0.02667775m,
            0.003837001m,
            0.03850541m,
            0.010892978m,
            -0.029228471m,
            -0.031412307m,
            0.013994026m,
            0.04049707m,
            -0.06869477m,
            0.006468524m,
            -0.06317403m,
            0.0088489065m,
            0.0428032m,
            0.0053591356m,
            -0.01746196m,
            0.029158588m,
            0.0008975569m,
            -0.011644217m,
            0.08008566m,
            0.01712128m,
            -0.025542155m,
            -0.03170931m,
            -0.0332642m];
}
